!!!
%html{lang: 'en', dir: 'ltr'}
  %head{prefix: fb_head_prefix}
    %meta{charset: 'utf-8'}
    = stylesheet_link_tag 'application', media: 'all'

    - # TODO Improve titles for SEO
    %title
      - if content_for?(:title)
        =  yield :title
        —
      Minefold

    %meta{name: 'author', content: 'Mütli Corp <http://mutlicorp.com>'}
    %meta{name: 'description', content: 'Play Minecraft on demand with friends.'}

    - case Rails.env
    - when 'production'
      = favicon_link_tag 'favicon.ico'
    - when 'staging'
      = favicon_link_tag 'favicon-staging.ico'
    - else
      = favicon_link_tag 'favicon-development.ico'

    %link{title: 'channel-url', href: facebook_channel_url(protocol: '//'), type: 'text/html'}
    %meta{property: 'fb:app_id', content: ENV['FACEBOOK_KEY']}
    = yield :open_graph

    - [144, 114, 72, 57].each do |size|
      = favicon_link_tag "apple-touch-icon-#{size}-precomposed.png", rel: 'apple-touch-icon-precomposed', sizes: "#{size}x#{size}", type: 'image/png'

    = stylesheet_link_tag '//get.pictos.cc/fonts/3288/1'

    /[if lt IE 9]
      %script{src: '//html5shim.googlecode.com/svn/trunk/html5.js'}
    %meta{'http-equiv' => 'X-UA-Compatible', :content => 'IE=edge,chrome=1'}

    = csrf_meta_tags

    // Crashm.at
    - if Rails.env.production?
      :javascript
        var _crashmat = #{crashmat_config.to_json};

        (function(w, d, cm, woe) {
          w.onerror = function(e,f,l,c) {
            cm.e = cm.e || []; cm.e.push([e,f,l,c]);
            if (woe) woe(e,f,l,c);
          };
          var e = d.createElement('script');
          e.async = true;
          e.src = '//db2uk9yp28y61.cloudfront.net/';
          (d.head || d.getElementsByTagName('head')[0]).appendChild(e);
        })(window, document, window._crashmat, window.onerror);

    // Mixpanel
    :javascript
      (function(c,a){window.mixpanel=a;var b,d,h,e;b=c.createElement("script");b.type="text/javascript";b.async=!0;b.src=("https:"===c.location.protocol?"https:":"http:")+'//api.mixpanel.com/site_media/js/api/mixpanel.2.js';d=c.getElementsByTagName("script")[0];d.parentNode.insertBefore(b,d);a._i=[];a.init=function(b,c,f){function d(a,b){var c=b.split(".");2==c.length&&(a=a[c[0]],b=c[1]);a[b]=function(){a.push([b].concat(Array.prototype.slice.call(arguments,0)))}}var g=a;"undefined"!== typeof f?g=a[f]=[]:f="mixpanel";g.people=g.people||[];h="disable track track_pageview track_links track_forms register register_once unregister identify name_tag set_config people.set people.increment".split(" ");for(e=0;e<h.length;e++)d(g,h[e]);a._i.push([b,c,f])};a.__SV=1.1})(document,window.mixpanel||[]);
      mixpanel.init(#{ENV['MIXPANEL'].to_json}, {cookie_name: 'mixpanel'});
      mixpanel.set_config({debug: false});

    - if signed_in?
      :javascript
        mixpanel.identify(#{current_user.distinct_id.to_json});
        mixpanel.people.set(#{mixpanel_person.to_json});

    // Typekit
    %script{type: 'text/javascript', src: '//use.typekit.net/qzl8aqw.js'}
    :javascript
      try{Typekit.load();}catch(e){}

    = yield :head


  %body{class: @layouts}
    #fb-root
    #Intercom

    - if signed_in?
      #facebooklikebanner
        .container
          %p
            Like Minefold on Facebook
          <iframe src="//www.facebook.com/plugins/like.php?href=https%3A%2F%2Fminefold.com&amp;send=false&amp;layout=standard&amp;width=450&amp;show_faces=true&amp;font=lucida+grande&amp;colorscheme=dark&amp;action=like&amp;height=80&amp;appId=160107270726261" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:300px; height:24px margin-left: 10px" allowTransparency="true"></iframe>


    %header
      .container
        .navbar.navbar-static-top
          .navbar-inner
            .pull-left
              = link_to 'Minefold', root_path, class: 'brand'

            .pull-right
              = render partial: 'shared/nav'

    .container
      - flash.select {|_,msg| msg.is_a?(String) }.each do |name, msg|
        %div.alert.alert-block{class: "alert-#{name}"}
          %a.close{data: {dismiss: 'alert'}} &#215;
          %div{:id => "flash_#{name}"}= msg

    - if content_for?(:breakout)
      = yield :breakout

    .container
      #app= yield

    %footer
      .container
        %ul.unstyled.pull-left
          %li= link_to 'Pricing', pricing_page_path
          %li= link_to 'Support', support_page_path
          %li= link_to 'About', about_page_path
          %li= link_to 'Developers', 'http://partycloud.com'
          %li= link_to 'Blog', 'http://blog.mutlicorp.com'

        %ul.social.unstyled.pull-right
          %li.twitter= link_to 'Twitter', 'https://twitter.com/minefold'
          %li.facebook= link_to 'Facebook', 'https://facebook.com/minefold'

        %p.copyright
          &copy;
          %a{href: 'http://mutlicorp.com'} Mütli Corp.

          Made for fun in San Francisco. #{link_to 'Privacy', privacy_page_path} & #{link_to 'Terms', terms_page_path}.

        .mixpanel-badge
          %a{href: 'https://mixpanel.com/f/partner'}
            %img{src: '//cdn.mxpnl.com/site_media/images/partner/badge_light.png', alt: 'Mobile Analytics'}


    / ---

    = javascript_include_tag '//d3dy5gmtp8yhk7.cloudfront.net/1.12/pusher.min.js'
    = javascript_include_tag 'https://js.stripe.com/v1'
    = javascript_include_tag 'application'

    :javascript
      window.pusher = new Pusher(#{Pusher.key.to_json});

    :javascript
      Stripe.setPublishableKey(#{ENV['STRIPE_PUBLISHABLE'].to_json});

    :javascript
      window.app = new Application();

    - if signed_in?
      :javascript
        window.app.currentUser = new Application.User(#{current_user.to_json});

    :javascript
      $(function() {
        Backbone.history.start();
      });

      window.fbAsyncInit = function() {
        FB.init({
          appId: #{ENV['FACEBOOK_KEY'].to_json},
          cookie: true,
          xfbml: true,
          logging: #{(not Rails.env.production?).to_json},
          channelUrl: #{facebook_channel_url(protocol: '//').to_json}
        });

        app.trigger('fb:init');

        FB.Event.subscribe('auth.authResponseChange', function(response) {
          if(response.status === 'connected') {
            app.trigger('fb:connected', response);
          } else if (response.status === 'not_authorized') {
            app.trigger('fb:not_authorized', response);
          } else {
            app.trigger('fb:'+response.status, response);
          }
        });

        FB.Event.subscribe('edge.create', function(url) {
          alert('You liked the URL: ' + url);
        });
      }

    = yield :tail


    // Facebook
    :javascript
      (function(d){
         var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
         if (d.getElementById(id)) {return;}
         js = d.createElement('script'); js.id = id; js.async = true;
         js.src = "//connect.facebook.net/en_US/all.js";
         ref.parentNode.insertBefore(js, ref);
       }(document));


    // Intercom
    - if signed_in?
      = intercom_script_tag

    - if signed_in?
      :javascript
        (function() {
          function async_load() {
            var s = document.createElement('script');
            s.type = 'text/javascript'; s.async = true;
            s.src = 'https://api.intercom.io/api/js/library.js';
            var x = document.getElementsByTagName('script')[0];
            x.parentNode.insertBefore(s, x);
          }
          if (window.attachEvent) {
            window.attachEvent('onload', async_load);
          } else {
            window.addEventListener('load', async_load, false);
          }
        })();


    // Analytics
    - if Rails.env.production?
      :javascript
        var _gauges = _gauges || [];
        (function() {
          var t   = document.createElement('script');
          t.type  = 'text/javascript';
          t.async = true;
          t.id    = 'gauges-tracker';
          t.setAttribute('data-site-id', #{ENV['GAUGES'].to_json});
          t.src = '//secure.gaug.es/track.js';
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(t, s);
        })();

      :javascript
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', #{ENV['GOOGLE_ANALYTICS'].to_json}]);
        _gaq.push(['_setDomainName', 'minefold.com']);
        _gaq.push(['_trackPageview']);

        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
