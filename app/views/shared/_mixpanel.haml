:javascript
  var mpq = [];
  mpq.push(["init", #{ENV['MIXPANEL_TOKEN'].to_json}]);
  (function(){var b,a,e,d,c;b=document.createElement("script");b.type="text/javascript";
  b.async=true;b.src="//api.mixpanel.com/site_media/js/api/mixpanel.js";a=document.getElementsByTagName("script")[0];
  a.parentNode.insertBefore(b,a);e=function(f){return function(){mpq.push(
  [f].concat(Array.prototype.slice.call(arguments,0)))}};d=["init","track","track_links",
  "track_forms","register","register_once","identify","name_tag","set_config"];for(c=0;c<
  d.length;c++){mpq[d[c]]=e(d[c])}})();

- # WARNING: Could potentially break page caching.
- if signed_in?
  :javascript
    mpq.identify(#{current_user.mpid.to_json});
    mpq.name_tag(#{current_user.email.to_s.to_json});
- else
  :javascript
    var mpid = null,
        pairs = document.cookie.split('; ');

    for (var i = 0, pair; pair = pairs[i] && pairs[i].split('='); i++) {
        if (decodeURIComponent(pair[0]) === 'mpid') {
          mpid = decodeURIComponent(pair[1] || '');
        }
    }

    if(!(mpid != null) || (mpid !== '')) {
      mpq.identify(mpid);
    }

- if params[:ref]
  :javascript
    mpq.register_once({ref: #{params[:ref].to_json}}, "all", "False", 365);
