- title 'Billing Details'

- head do
  %script{src: 'https://js.stripe.com/v1'}
  :coffeescript
    Stripe.setPublishableKey #{ENV['STRIPE_PUBLISHABLE'].to_json}

%form
  %section.card-number
    %h3= label_tag :number, 'Card Number'
    %fieldset
      = text_field_tag :number, '', name: nil, size: 20, autocomplete: 'off', class: %w{stripe number}, id: 'stripe-number'

      %p.card-types
        We accept <span class="visa">Visa</span>, <span class="mastercard">MasterCard</span>, <span class="american-express">American Express</span>, <span class="discover">Discover</span>, <span class="jcb">JCB</span> and <span class="diners-club">Diners Club</span>.

      :coffeescript
        $('input.stripe.number').keyup (e) ->
          target = $(e.target)
          cardType = Stripe.cardType(target.val())
            .toLowerCase()
            .replace(/\s/,'-')

          $('.card-types span')
            .toggleClass('unknown', cardType isnt 'unknown')
            .removeClass('active')
            .filter(-> $(@).hasClass(cardType))
            .addClass('active')

  %section.card-cvc
    %h3= label_tag :cvc, 'CVC'
    %fieldset= text_field_tag :cvc, '', name: nil, size: 4, autocomplete: 'off', class: %w{stripe cvc}, id: 'stripe-cvc'

  %section.card-expiration
    %h3= label_tag :expiry_month, 'Expiration (MM/YYYY)'
    %fieldset
      = text_field_tag :expiry_month, '', name: nil, size: 2, class: %w{stripe expiry-month}, id: 'stripe-exp-month'
      %span /
      = text_field_tag :expiry_year, '', name: nil, size: 4, class: %w{stripe expiry-year}, id: 'stripe-exp-year'

%a#secured-by{href: 'https://stripe.com', target: '_blank'}
  Secured by
  = image_tag 'stripe.png', width: 72, height: 31

= form_for current_user, url: customer_create_path, :id => 'new_order' do
  - if params[:plan]
    = hidden_field_tag :plan, params[:plan]
  - elsif params[:hours]
    = hidden_field_tag :hours, params[:hours]

  .errors

  %fieldset
    %input{type: 'submit', value: 'Continue'}

:coffeescript
  form = $('form.edit_user')

  form.submit (e) ->
    e.preventDefault()

    button = form.find('input[type=submit]')

    button.attr(disabled: true)
    form.find('.spinner').show()

    card =
      number:    $('#stripe-number').val()
      cvc:       $('#stripe-cvc').val()
      exp_month: $('#stripe-exp-month').val()
      exp_year:  $('#stripe-exp-year').val()


    Stripe.createToken card, #{@amount.to_i.to_json}, (status, response) ->
      console.log status, response
      if status isnt 200
        button.attr(disabled: false)

        $('<p></p>')
          .addClass('stripe')
          .text(response.error.message)
          .appendTo form.find('.errors').empty()

      else
        token = response.id
        $('<input></input>')
          .attr(type: 'hidden', name: 'user[stripe_token]')
          .val(token)
          .appendTo(form)

        form.get(0).submit()
