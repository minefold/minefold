= flash[:errors].to_json if flash[:errors]

.new-world
  %header
    %h1
      %strong Create
      a new world

  = form_for @world do |f|
    = f.text_field :name, :placeholder => 'Name'

    %p
      = f.submit 'Create'

.import-world
  %header
    %h1
      or
      %strong upload
      an existing world

  = flash[:errors].to_json if flash[:errors]

  - new_world_id = BSON::ObjectId.new

  #import-world
    #upload
      = raw s3_swf_upload_tag(keyPrefix: "#{new_world_id}-")
    #uploading(style="display:none")
      %p New world's name:

      = form_for World.new do |f|
        = f.hidden_field :_id, :value => new_world_id
        = f.hidden_field :status, :value => 'pending_import'

        = f.text_field :name, :placeholder => 'Name'
        %p
          = f.submit 'Create'

    %p.status

:javascript
  $(function(){
    var worldId = '#{new_world_id}';
    var worldUploaded = false;
    var worldInfoProvided = false;

    var $status = $('#import-world .status');

    var currentFile;

    function createWorldIfReady() {
      if (worldUploaded && worldInfoProvided) {
        $('#import-world #uploading form input').attr('disabled', false);
        $('#import-world #uploading form').submit();
      }
    }

    s3_swf_1_object.onFileAdd = function(file) {
      currentFile = file;
      $('#import-world #uploading').show();
      s3_swf_1_object.startUploading();
      $status.text('Uploading...');
    };

    s3_swf_1_object.onUploadComplete = function(options, event) {
      $('#import-world #upload').show();
      $status.text('Finished');

      $.post('/world_imports', {
        world_import: { world_id: worldId, filename: currentFile.name }
      }, function(){
        worldUploaded = true;
        createWorldIfReady();
      });
    };

    s3_swf_1_object.onUploadError = function(file, e) {
      $status.text('Error: ' + e);
      console.log(e);
    }
    s3_swf_1_object.onUploadIOError = function(file, e) {
      $status.text('IO Error: ' + e);
      console.log(e);
    }
    s3_swf_1_object.onUploadProgress = function(file, progress) {
      percentage = (progress.bytesLoaded / progress.bytesTotal).toFixed(2) * 100;
      $status.text(percentage.toFixed(0) + '%')
    }




    $('#import-world #uploading form').one('submit', function(e){
      e.preventDefault();
      worldInfoProvided = true;
      $('#import-world #uploading form input').attr('disabled', 'disabled');

      createWorldIfReady();
    });


  });
