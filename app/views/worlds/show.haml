- title world.name do
  = render partial: 'worlds/header'

- if flash[:success]
  .flash.success= flash[:success]

- if !world.public_activity? and not (signed_in? and (world.public? or world.whitelisted?(current_user)))
  .locked
    Sorry, this world's activity stream is private.

- else
  #stream
    - if signed_in? and (world.public? or world.whitelisted?(current_user))
      #share
        = form_tag wall_items_path(world), method: :post do |f|
          .avatar
            = image_tag current_user.gravatar_url(size: 36)
          = text_area_tag :body, nil, rows: 2, autofocus: true, required: true

          .submit
            %button Chat
            .advice ENTER to chat, SHIFT-ENTER for a new line.

      :javascript
        window.current_user = #{current_user.to_json(only: [:id, :username, :email])};
        current_user.gravatar_url = Gravtastic(current_user.email);

      :coffeescript
        f = $('#share form')

        f.submit (e) ->
          e.preventDefault()

          data =
            chat:
              user_id: current_user.id
              raw: f.find('textarea').val()

          cId = _.uniqueId()

          $.ajax
            type: f.attr('method')
            url: f.attr('action')
            data:
              chat:
                raw: f.find('textarea').val()
              socket_id: pusher.connection.socket_id
            dataType: 'json'
            success: (data) ->
              $('#wall-items #chat_'+cId)
                .removeClass('loading')
                .attr(id: "chat_"+data._id)

          data.chat.body = data.chat.raw
          data.chat.user = current_user
          data.chat.id = cId

          html = Mustache.renderTemplate('worlds/_wall_item', data.chat)
          $('#wall-items').prepend $(html).addClass('loading')

          f.find('textarea').val('')

        f.find('textarea')
          .focus ->
            f.find('.advice').removeClass('hidden')
          .blur ->
            f.find('.advice').addClass('hidden')
          .keydown (e) ->
            if e.keyCode is 13 and !e.shiftKey and !e.ctrlKey and !e.altKey
              e.preventDefault()
              f.submit()


    #wall-items
      = template 'worlds/_wall_item', collection: world.wall_items.order_by([:created_at, :desc]).limit(100)


    = javascript_include_tag 'http://js.pusherapp.com/1.9/pusher.min.js'

    :coffeescript
      window.pusher = new Pusher(#{Pusher.key.to_json});
      window.channel = pusher.subscribe(#{Pusher[world.pusher_key].name.to_json});

      channel.bind 'chat-create', (data) ->
        data.id = data._id
        data.body = data.raw

        html = Mustache.renderTemplate('worlds/_wall_item', data)
        $('wall-items').prepend $(html)
