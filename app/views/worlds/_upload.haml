- head do
  = javascript_include_tag '//ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js'

= form_for :world_upload, html: {id: 'world-upload'} do |f|
  = f.file_field :path

  .progress{hidden}
    .bar
  .status{hidden}

  %p.state.processing{hidden}
    %strong Processing world
    This may take a few minutes depending on the size of your world.

  %p.state.error{hidden}
    %strong Error:
    %span.message

  %p.note{hidden}
    Make sure you've followed the instructions to the tee. If you <em>still</em> continue to have problems, email your world as an attachment to #{mail_to 'support@minefold.com'}.

:coffeescript
  $ -> 
    pusher = new Pusher(#{Pusher.key.to_json}, encrypted: true)
    maxFileSize = 1 * 1024 * 1024 * 1024 # 1Gb

    createForm = $('form#new_world')
    uploadForm = $('form#world-upload')
    
    uploadForm.bind 'upload-in-progress', => $('input[name=commit]', @).disable()
    uploadForm.bind 'upload-succeeded', => $('input[name=commit]', @).enable()
    uploadForm.bind 'upload-failed', => $('input[name=commit]', @).enable()

    status = $('form .status')
    processing = $('form .processing')
    
    previouslyUploaded = $('#world_world_upload_id').val().length > 0
    
    uploadForm.s3upload
      prefix: '#{[current_user.safe_username, current_user.id, Time.now.strftime('%Y%m%d%H%M%S')].join('-')}'
      text: (if previouslyUploaded then 'Finished' else 'Upload your world')
      signature_url: #{policy_upload_path(format: :xml).to_json}
      required: true
      submit_on_all_complete: false
      onselect: (info, swf) ->
        if parseInt(info.size) < maxFileSize
          swf.upload()
          $('#world_upload_path').val('Uploading '+info.name)
          return false

      onstart: =>
        $('p.state').hide()
        $('.progress').show()
        status.show()
        uploadForm.trigger 'upload-in-progress'
        
      onprogress: (progress, info) ->
        $('form .progress .bar').css width: (progress * 100) + '%'
        status.text(Math.ceil( progress * 100 ) + '%')
        false

      onerror: (msg) ->
        status.addClass('error').text(msg)
        uploadForm.trigger 'upload-failed'

      oncomplete: (info) ->
        $('.progress').add($('.status')).slideUp()
        $('#world_upload_path').val('Processing...')
        processing.show()

        $.ajax
          type: 'POST'
          url: '#{upload_path}'
          data: info
          dataType: 'json'
          success: (data) ->
            channel_name = 'WorldUpload-' + data.id
            channel = pusher.subscribe channel_name

            channel.bind 'success', (data) ->
              $('p.state').hide()
              $('#world_upload_path').val('Finished')
              $('input#world_world_upload_id').val(data.world_upload.id)
              uploadForm.trigger 'upload-succeeded'

            channel.bind 'error', (message) ->
              $('p.state').hide()
              $('#world_upload_path').val('Upload your world')
              $('.error .message').text(message)
              $('.error').show()
              $('.note').show()
              form.trigger 'upload-failed'
        
