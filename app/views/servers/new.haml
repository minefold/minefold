- title 'Create a new server'

- # TODO Hack!
- @funpack = Funpack.first

:css
  fieldset, .tab-pane, .tab-content {
    overflow: visible;
  }

.row
  .span6.offset1
    = form_for server, html: {class: 'tab-content'} do |f|

      / Game
      / --

      %fieldset.tab-pane.active#game
        %ol.progressmeter.progressmeter-3
          %li.active
            %a{href: '#game', data: {toggle: 'tab'}} Game
          %li Settings
          %li Billing

        - @games.each do |game|
          .control-group
            %h3.control-label= game.name
            .controls
              - game.funpacks.each do |funpack|
                %label.radio{for: "server_funpack_id_#{funpack.id.to_s}", style: 'margin-bottom:20px'}
                  %input{type: 'radio', name: 'server[funpack_id]', value: funpack.id.to_s, id: "server_funpack_id_#{funpack.id.to_s}"}

                  %strong.name{style: 'margin-right:10px'}
                    = funpack.name
                  %small= link_to "Official Site", funpack.info_url, target: '_blank'
                  .description= markdown(funpack.description)


        %center.alert
          Want other mods?
          %a{href: "http://partycloud.com/?email=#{u(current_user.email)}"} Sign up at the Party Cloud
          to get first access to Minefold's developer platform.

        .form-actions
          %a.btn.btn-primary.pull-right#game-next-button{href: '#settings', disabled: true} Settings &rarr;

      - content_for :tail do
        :javascript
          $('input[name="server[funpack_id]"]').change(function() {
            var $this = $(this),
                funpackId = $this.val(),
                url = #{new_funpack_settings_servers_path.to_json};

            $.ajax(url, {
              accepts: 'text/html',
              data: { funpack_id: funpackId },
              dataType: 'html',
              type: 'GET'
            }).
            error(function() {
              // console.log('error');
            }).
            done(function(html) {
              $('#new_funpack_settings').html(html);
              $('#game-next-button').
              click(function(e) {
                  e.preventDefault();
                  $(this).tab('show');
                }).
              attr('disabled', false);
            });

          });


      / Settings
      / --

      %fieldset.tab-pane#settings
        %ol.progressmeter.progressmeter-3
          %li.previous
            %a{href: '#game', data: {toggle: 'tab'}} Game

          %li.active
            %a{href: '#settings', data: {toggle: 'tab'}} Settings

          %li Billing

        %hr

        = f.control_group :name do
          .controls
            = f.text_field :name, placeholder: 'Name', style: 'width:100%'

        %hr.large

        #new_funpack_settings

        .form-actions
          %a.btn.pull-left{href: '#game', data: {toggle: 'tab'}} &larr; Game
          %a.btn.btn-primary.pull-right{href: '#billing', data: {toggle: 'tab'}} Billing &rarr;


      / Billing
      / --

      %fieldset.tab-pane#billing
        %ol.progressmeter.progressmeter-3
          %li.previous
            %a{href: '#game', data: {toggle: 'tab'}} Game

          %li.previous
            %a{href: '#settings', data: {toggle: 'tab'}} Settings

          %li.active
            %a{href: '#settings', data: {toggle: 'tab'}} Billing

        - if not can_create_shared_servers?(current_user, @funpack)
          - if not current_user.minecraft_linked?
            .alert
              You need to
              = link_to 'link your Minecraft account', edit_user_registration_path
              before you can create or play on shared servers.

          - # TODO Alert if the funpack doesn't support shared servers


        = f.control_group :shared do
          %table.table.server-types-table{class: ('is-shared-disabled' unless can_create_shared_servers?(current_user, @funpack))}
            %thead
              %tr
                %th
                %th.normal
                  Normal Server
                  %br
                  %small You pay the cost
                %th.shared
                  Shared Server
                  %br
                  %small Split cost with friends


            %tbody
              %tr.availability-row
                %td Availability
                %td.normal
                  On-demand
                  %br
                  %small Manual start and stop.
                %td.shared
                  Always up
                  %br
                  %small The server is running 24/7.

              %tr.who-pays-row
                %td Who pays?
                %td.normal
                  You
                  %br
                  %small (only while it's running)
                %td.shared
                  Players
                  %br
                  %small (only while they're playing)

              %tr.how-much-row
                %td How much?
                %td.normal
                  %span.num 5
                  %small cr/min
                %td.shared
                  %span.num 1
                  %small cr/min each

              %tr.checkbox-row
                %td
                %td.normal
                  - # TODO %p is a hack
                  %p= f.radio_button :shared, false, selected: false
                %td.shared
                  %p= f.radio_button :shared, true, selected: false, disabled: (!can_create_shared_servers?(current_user, @funpack))

        .form-actions
          %a.btn.pull-left{href: '#settings', data: {toggle: 'tab'}} &larr; Settings
          = f.submit 'Create server', class: %w(btn btn-primary pull-right), id: 'final-submit'

        - content_for :tail do
          :javascript
            $(document).ready(function() {
              var table = $('.server-types-table'),
                  submit = $('#final-submit'),
                  colHover = function(col) {
                    return function() {
                      table.find("."+col).toggleClass('hover', !$(this).hasClass('hover'));
                    }
                  },
                  colSelect = function(col) {
                    return function() {
                      table.find('th,td').removeClass('is-active');
                      table.find('.'+col).addClass('is-active');
                      table.find('.'+col+' input[type=radio]').attr({checked: true});
                    }
                  };

              table.find('.normal').
                hover(colHover('normal')).
                click(colSelect('normal')).click(function() {
                  submit.val('Create a normal server');
                });

              table.find('.shared').
                hover(colHover('shared')).
                click(colSelect('shared')).click(function() {
                  submit.val('Create a shared server');
                });

              table.find('.normal').click();
            });
