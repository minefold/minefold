<% title server.name, "#{server.funpack.name} Server #{server.id}" %>
<% layout :servers %>

<%= track 'Viewed server', name: server.name, url: server_url(server) %>
<%= track_landing_type 'server' %>

<script>
  app.server = new Server(<%= render(server, :format => :json) %>);
  var channel = pusher.subscribe("server-" + app.server.get('id'));
  channel.bind('server:started', app.server.onStarted);
  channel.bind('server:stopped', app.server.onStopped);
</script>

<% if flash[:abba_complete] %>
  <script>Abba('Sign up url', { persist: true }).complete()</script>
<% end %>

<div class="page">
  <%= render partial: 'header', locals: {active: 'home'} %>

  <% if false %>
    <div class="page-section">
      <a class="btn btn-large btn-block btn-primary" href="<%= edit_server_path(server) %>">Change gameplay settings</a>
      <br />
      <%= render partial: "funpacks/getting_started/minecraft" %>
    </div>
  <% end %>

  <% if false %>
    <%= javascript_include_tag '//maps.google.com/maps/api/js?sensor=false' %>
    <div class="page-box map-view" id="map-view-el"></div>
    <script>
      app.map = new App.Map({"id":12934,"serverId":12934,"host":"//d14m45jej91i3z.cloudfront.net","zoomLevels":7,"tileSize":384,"lastMappedAt":"2012-12-05T10:35:24+00:00","createdAt":"2012-11-27T23:04:55+00:00","updatedAt":"2012-12-05T10:35:44+00:00","spawn":{"x":0,"y":66,"z":0}});
    </script>
    <script>
      app.mapView = new App.MapView({model: app.map});
      $(document).ready(function() {
        app.mapView.setElement($('#map-view-el'));
        app.mapView.render();
      });
    </script>
  <% end %>

  <div class="server-controls" data-state="<%= control_state(server) %>">
    <!-- TODO: Don't know how to connect to this address? -->
    <!-- TODO: Steam connect button -->
    <% if server.playable? %>
      <input type="text" id="server-<%= server.id %>-address" value="<%= server.address %>" />
    <% elsif server.starting? %>
      Server is starting
    <% else %>
      <a class="btn btn-block btn-primary btn-large">Start this server</a>
    <% end %>
  </div>

  <ul class="stats-tabs">
    <li class="stat">0 <span>players now</span></li>
    <li class="stat">0 <span>players ever</span></li>
    <li class="stat">0 <span>server hours</span></li>
    <li class="stat">0 <span>player hours</span></li>
  </ul>

  <% if server.description? %>
    <div class="page-section">
      <%= markdown(server.description) %>
    </div>
  <% end %>

  <div class="page-section">
    <%= form_for :post, url: server_posts_path(server), :method => :post do |f| %>
      <div class="control-group">
        <%= f.text_area :body, rows: 2, placeholder: "Leave a note", class: "input-block-level" %>
      </div>
      <%= f.submit 'Post your note', class: %w(btn) %>
    <% end %>
  </div>

  <div class="activity-stream">
    <%= render partial: server.activity_stream.page(0), :as => :activity %>
  </div>

</div>
