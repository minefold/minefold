- title server.name, "#{server.funpack.name} Server #{server.id}"
- layout :servers

= track 'Viewed server', name: server.name, url: server_url(server)
= track_landing_type 'server'

:javascript
  app.server = new Server(#{render(server, :format => :json)});
  var channel = pusher.subscribe("server-" + app.server.get('id'));
  channel.bind('server:started', app.server.onStarted);
  channel.bind('server:stopped', app.server.onStopped);

- if flash[:abba_complete]
  :javascript
    Abba('Sign up url', { persist: true }).complete()

.container
  = render partial: 'header'

  %ul.nav.nav-tabs
    %li.active= link_to 'Activity', server
    - if server.funpack.maps?
      %li= link_to 'Map', server_map_path(server)
    - if can? :update, server
      %li= link_to 'Settings', [:edit, server]

  .row
    .span8
      - if signed_in?
        .pull-left{style: 'margin-right: 20px'}
          = image_tag current_user.avatar.medium.url, width: 40, height: 40

        .pull-left{style: 'margin-bottom: 20px'}
          = form_for [server, Post.new], :method => :post do |f|
            .control-group
              = f.text_area :body, rows: 2, placeholder: 'Write a post', class: 'span7'
            = f.submit 'Write post', class: %w(btn btn-small)

      .activity-stream
        = render partial: server.activity_stream.page(0), :as => :activity

    .span4
      - if server.description?
        .server-description
          = markdown(server.description)

        - if can?(:update, server)
          %p
            (
            %a{href: edit_server_path(server)}> Edit description
            )

  - if !server.sessions.any? and server.funpack.instructions?

    %ul.nav.nav-tabs.ab-control
      %li.active= link_to 'Activity', server
      - if server.funpack.maps?
        %li= link_to 'Map', server_map_path(server)
      - if can? :update, server
        %li= link_to 'Settings', [:edit, server]

    .row.ab-control
      .span8
        = render partial: 'activity'

      .span4
        = render partial: 'sidebar'


    %ul.nav.nav-tabs.ab-variant
      %li.active= link_to 'Getting Started', server
      - if can? :update, server
        %li= link_to 'Settings', [:edit, server]

    .row.ab-variant
      .span8
        = render partial: "funpacks/getting_started/#{server.funpack.slug}"

    = ab_test 'New server page', 'Show getting started'

  - else

    - content_for :tail do
      :javascript
        Abba('New server page', { persist: true }).complete()

    %ul.nav.nav-tabs
      %li.active= link_to 'Activity', server
      - if server.funpack.maps?
        %li= link_to 'Map', server_map_path(server)
      - if can? :update, server
        %li= link_to 'Settings', [:edit, server]

    .row
      .span8
        = render partial: 'activity'

      .span4
        = render partial: 'sidebar'
